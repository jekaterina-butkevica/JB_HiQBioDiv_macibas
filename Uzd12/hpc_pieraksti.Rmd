---
title: "Untitled"
author: "Jekaterīna Butkeviča"
date: '`r Sys.Date()`'
output: html_document
---

Saite: https://nohap.hpc-net.lv/profile/

Access resourse -> Open on Demand (resurs, vizuālais interfeis saiskarē ar klasteru).


Open in terminal (no māju direktorijas)

*sinfo -Nl* (informācija par klastera resursiem)

NODELIST   - mezgla nosaukums
PARTITION  - partīcija (weakold - vecāka, debug (interaktīva))
STATE      - stāvoklis (allocated - pilnība aizņemts mized - daļēji aiņemts, idle - pilnīgi brīvs, down - nestradā).
CPUS       -  kodoli

*squeue* - apskatīt uzdevumus, kas šobrīd reķinājas

*history* - var apskatī vecas komandas

Klasteriem nepatik relatīvie ceļi.

*mkdir* - izveidot direktiruhy
*cd* - change direktory 
*ls*- failu lists


*cd ~* - ātri uz māju direktoriju
rmdir - novākt tukšu direktoriju
rm -r - novākt direktoriju kopā ar visus tas saturu


## Programmatūra

Programmatūra - saucas moduli.

*module avail* - visa pieejama programmatura
*module avail R* – visa pogrammatūra, kas satur R

*module load R/4.3.5* - pievienot noteikto moduli (šeit – R)
Bet klasterim veidojas problēmas ar C valodu. Tādēļ:
 
*module unload R* - atvienot noteikto modeuli (šeit – R)


*module load R/4.1.2 * - pievienojam citu versij un viss stradā.

Visas pakas jāinstāle:
**instal.packages("sf")** Dabūjam problēmas ar sistēmas līmeņa bibliotēkam.

======== Nospiest escape, lai izzīetu no R konsoles =========


*module unload R*

Konteinier - sapakota programmatūra, lai pārceltu un stradātu tur, kur vajag

singularity - proggrammatūra, lai stradātu ar konteinieriem.

*module load singularity*

rocker - konteinieri ar pēdējām R versijaām un pakam. Ir nepiecviešamas izveidot savu lokālo zatu savā māju mapē konteinieram (direktorijas, kur tiks būvēts konteiniers):

*module load singularity*
*mkdir -p "$HOME/build_tmp" "$HOME/appt_cache"*
*export SINGULARITY_TMPDIR="$HOME/build_tmp"*
*export SINGULARITY_CACHEDIR="$HOME/appt_cache"*
*export TMPDIR="$HOME/build_tmp"*

*singularity build geospatial_4.5.2.sif docker://rocker/geospatial:4.5.2* - uzdevums būvēt konteiniru (instalējam datoru).


*ls* - tagad jjāparadas jauniem failiem

*singularity shell geospatial_4.5.2.sif* - ieet iekšā singulārity image failā
*R* un jāizvēlas versija

=== Nokļuvam R konsole ===

**library(sf)**

q() - pamest R

exit - izkapt no konteiniera









## Uzdevuma piemērs

Uzrakstīt .R skriptu, pievienot direktorija un, tad no bash konsoles palaist to kā skripta failu:

```{bash}
#!/bin/bash - PIRMAIS "#" SPECIFISKI TIKAI SLURMAM LASAMA DAĻĀ
#SBATCH --job-name=pirmais			# īss uzdevuma nosaukums
#SBATCH --partition=regular			# regular vai weakold
#SBATCH --ntasks=1				      # paralēli notiekošu uzdevumu skaits. Mums tas vienmēr ir 1
#SBATCH --cpus-per-task=1       # kodolu skaits, kurus izmantot uzdevuma veikšanai
#SBATCH --time=00:05:00   			# Time limit, hrs:min:sec
#SBATCH --mem=4G      		  		# Kopējā atmiņa - ierobezota
#SBATCH --output=pirma_izvade.out			 # Standard output and error log


echo "Starting job"
echo "Date = $(date)"
echo "Node hostname = $(hostname -s)"
echo "Working Directory = $(pwd)"
echo ""
echo "Loading modules"

module load singularity
srun singularity exec geospatial_4.5.2.sif Rscript piemersR.R #IZPILDĪT rSCRIPTU PIEMERS GEOSPATIAL KONTEINIERA


echo ""
echo "All done on $(date)"
```


Atvert terminālu no hqbiodiv mapes.

Direktorija:

hpc_io (hpc in/out) - kopīgājiem uzdevumiem



https://ood.hpc.lu.lv/pun/sys/dashboard/files/fs//home/hiqbiodiv/hpc_io/Jobs_shell/2024/SDMs/Amphibia/sdms_BOMBOM_v1.sh 

```{bash}
#!/bin/bash
#SBATCH --job-name=BOMBOM_v1			 # Job name
#SBATCH --partition=regular			 # Partition name
#SBATCH --ntasks=1				 # Number of tasks
#SBATCH --cpus-per-task=1
#SBATCH --mem=60G				 # Kopējā atmiņa
#SBATCH --time=100:00:00			 # Time limit, hrs:min:sec
#SBATCH --output=hpc_io/Outfiles/2024/SDMs/Amphibia/sdms_BOMBOM_v1.out			 # Standard output and error log #JAMAINA KUR NOLIKT SKRIPTS


# VISS LEJĀ - RIŅĶA DANCIS, LAI IZMANTOTU KONTEINIERU NO AAVJ DIREKTORIJAS DIREKTORIJĀ AUGSTĀK PAR TO
set -euo pipefail

# Absolute paths (avoid ../ relative surprises)
PROJECT_ROOT="/home/hiqbiodiv"
IMG="${PROJECT_ROOT}/hiqbiodiv-container_20251224.sif"
WORKDIR="${PROJECT_ROOT}"
SCRIPT="${WORKDIR}/RScripts_final/sdms/Amphibia/sdms_BOMBOM_v1.R" # JAMAINA KUR ATRODAS UN KĀ SAUCAS SKRIPTS

echo "Starting job"
echo "Date = $(date)"
echo "Node hostname = $(hostname -s)"
echo "Submit dir  = $(pwd)"

module load singularity

echo "Host check:"
ls -l "$SCRIPT" || { echo "Script not found on host: $SCRIPT"; exit 1; }

# Bind the project into the container and set the PWD inside the container
# Bind to the same path to keep file references identical.
echo "Running in container..."
srun singularity exec \
  -B "${PROJECT_ROOT}:${PROJECT_ROOT}" \
  --pwd "${WORKDIR}" \
  "${IMG}" \
  Rscript --vanilla "${SCRIPT}"

echo "All done on $(date)"
```



RScriptsFinal - viņa final kodi https://ood.hpc.lu.lv/pun/sys/dashboard/files/fs//home/hiqbiodiv/RScripts_final

Amfibijai: 
https://ood.hpc.lu.lv/pun/sys/dashboard/files/fs//home/hiqbiodiv/RScripts_final/sdms/Amphibia


## Piemērs ar BOMBOM

```{r}
# header ----
grupa="Amphibia"
sugaEGV="BOMBOM"
suga="BOMBOM"
suga_versija=paste0(suga,"v0")
piepules_radiuss_m=1500
grupas_mainigajiem="./SpeciesModels/00_EGVtables/EGVtable_AllSpecies.xlsx"
noverojumu_tabula="./SpeciesModels/00_Observations/Observations6_AAvj_tikls.csv"

fs::dir_create(paste0("./SpeciesModels/",grupa,"/",suga_versija))
```

Paku ielāde:

```{r}

# libs -----
suppressPackageStartupMessages(library(plotROC))
suppressPackageStartupMessages(library(ecospat))
suppressPackageStartupMessages(library(maxnet))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(terra))
suppressPackageStartupMessages(library(sf))
suppressPackageStartupMessages(library(arrow))
suppressPackageStartupMessages(library(sfarrow))
suppressPackageStartupMessages(library(usdm))
suppressPackageStartupMessages(library(maps))
suppressPackageStartupMessages(library(rasterVis))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(SDMtune))
suppressPackageStartupMessages(library(ENMeval))
suppressPackageStartupMessages(library(zeallot))
suppressPackageStartupMessages(library(openxlsx))
suppressPackageStartupMessages(library(blockCV))
suppressPackageStartupMessages(library(overlapping))
```

Ņemam mainigus, izmantojam pazīmēs ar VIF < 10:

```{r}
# vif -----

print("Sāku VIF: ")
print(Sys.time())

grupas_mainigie=read_excel(grupas_mainigajiem)


mainigajiem2=grupas_mainigie %>% 
  pivot_longer(cols=9:length(names(grupas_mainigie)),
               names_to="sugas_kodi",
               values_to="atzimes") %>% 
  filter(sugas_kodi==sugaEGV) %>% 
  filter(!is.na(atzimes))

grupai=paste0("./RasterGrids_100m/2024/Scaled/",mainigajiem2$egv_filename)

mainigie=terra::rast(grupai)
set.seed(1);solots_vif=usdm::vifstep(mainigie,th=10,size=10000)

write_rds(solots_vif,
          paste0("./SpeciesModels/",
                 grupa,"/",
                 suga_versija,"/",
                 "VIFstep10k_",suga,".RDS"))
vifrez=as.data.frame(solots_vif@results)
mainigajiem3=left_join(mainigajiem2,vifrez,by=c("egv_layername"="Variables"))
openxlsx::write.xlsx(mainigajiem3,
                     paste0("./SpeciesModels/",
                            grupa,"/",
                            suga_versija,"/",
                            "VIFs_",suga,".xlsx"))
```




Telpiskas autokorelācijas analīze. Saveidoti bloki, telpiski neatkarīgas režģa šunas. ŠO VEICAM TIKAI SUGAM, KAM LĪDZ 6 SOLIM SAGLABĀJUĪSES VISMAZ 30 NOVĒROJUMI.

```{r}
spatial autocorrelation -----

print("Sāku autokorelācijas analīzi: ")
print(Sys.time())




mazmainigajiem=mainigajiem3 %>% 
  filter(!is.na(VIF))
mazmainigo_celi=paste0("./RasterGrids_100m/2024/Scaled/",
                       mazmainigajiem$egv_filename)
mazmainigie=rast(mazmainigo_celi)

set.seed(1);blokiem=blockCV::cv_spatial_autocor(r=mazmainigie,num_sample=30000)
write_rds(blokiem,paste0("./SpeciesModels/",
                         grupa,"/",
                         suga_versija,"/",
                         "blockCV_",suga,".RDS"))
```



JA IR STARP 30 UN 20, TAD (komentets vai bnodzests), jo neveicam telpisko autokorelācijas anallīzi, jo neveidosim neatkarīgo kopu, vienkārši veicam 4 telpiskus blokus validacijai.

```{r}
# spatial autocorrelation -----

#print("Sāku autokorelācijas analīzi: ")
#print(Sys.time())




#mazmainigajiem=mainigajiem3 %>% 
#  filter(!is.na(VIF))
#mazmainigo_celi=paste0("./RasterGrids_100m/2024/Scaled/",
#                       mazmainigajiem$egv_filename)
#mazmainigie=rast(mazmainigo_celi)

#set.seed(1);blokiem=blockCV::cv_spatial_autocor(r=mazmainigie,num_sample=30000)
#write_rds(blokiem,paste0("./SpeciesModels/",
#                         grupa,"/",
#                         suga_versija,"/",
#                         "blockCV_",suga,".RDS"))
```


Ja sugai mazāk par 20 novērojumiem, šobrīid nedaram neko. (Sobrid nedaram).


Visām sugam: effort bias. Izvēlētas sugu grupas ietvaros, paņem novērojumus no 16 gada, atlasa interesejošo (visu taksonomisko grupu), atfitre sugas, kam ir >2 nov, katrai sugai aprekina sezonalitāti pret dienu kopš gada sākumu  un parklājam merķā sugu ar katru no sugas grupas.


```{r}
# effort bias -----

print("Sāku piepūles raksturošanu: ")
print(Sys.time())


visinoverojumi=read_csv(noverojumu_tabula)
merksuga=visinoverojumi %>% 
  filter(CODE==suga) %>% 
  filter(Year>=2016) %>%
  mutate(DoY=lubridate::yday(Date))
visagrupa=visinoverojumi %>% 
  filter(Year>=2016) %>%
  filter(Group==grupa) %>% 
  mutate(DoY=lubridate::yday(Date)) %>% 
  group_by(CODE2) %>% 
  mutate(skaits=n()) %>% 
  ungroup() %>% 
  filter(skaits>=2)

table(visagrupa$CODE)

kodi=levels(factor(visagrupa$CODE))
parklajumiem=data.frame(sugas=kodi,
                        parklajumi=NA)

for(i in seq_along(kodi)){
  kods=kodi[i]
  vektors=visagrupa %>% 
    filter(CODE==kods)
  saraksts=list(pirmais=merksuga$DoY,
                otrais=vektors$DoY)
  parklajums=overlap(saraksts, 
                     plot=FALSE,
                     pairsOverlap = TRUE,
                     type="2")
  parklajumiem$parklajumi[i]=parklajums$OV
}

parklajumiem=parklajumiem %>% 
  mutate(svarots=parklajumi/sum(parklajumi))

write_csv(parklajumiem,paste0("./SpeciesModels/",
                              grupa,"/",
                              suga_versija,"/",
                              "ActivityWeights_",suga,".csv"))


visagrupa2=visagrupa %>% 
  filter(Year>=2016) %>%
  filter(Mislocation_Sea==0) %>% 
  filter(Mislocation_CLC==0) %>% 
  filter(AccumDW_cell<=0.1) %>% 
  filter(AccumTCL_cell<=0.1) %>% 
  filter(AccumDW_hr<=0.25) %>% 
  filter(AccumTCL_hr<=0.25)

kodi=levels(factor(visagrupa2$CODE))
template100=terra::rast("./Templates/TemplateRasters/LV100m_10km.tif")

for(i in seq_along(kodi)){
  kods=kodi[i]
  noverojumi=visagrupa2 %>% 
    filter(CODE==kods)
  piepulei=MASS::kde2d(noverojumi$LKS_X, noverojumi$LKS_Y,
                       h = piepules_radiuss_m, n = c(nrow(template100), ncol(template100)), 
                       lims = c(302800, 772800, 162900, 448900))
  piepulei_rastrs=terra::rast(piepulei)
  piepulei_match=terra::resample(piepulei_rastrs, template100, method = "bilinear")
  piepulei_maskets=crop(piepulei_match,template100,mask = TRUE)
  slana_nosaukums=paste0("./SpeciesModels/",
                         grupa,"/",
                         suga_versija,"/",
                         "Effort_",kods,".tif")
  writeRaster(piepulei_maskets,
              filename=slana_nosaukums,
              overwrite=TRUE)

}

piepules_slaniem=list.files(paste0("./SpeciesModels/",grupa,"/",suga_versija,"/"),
                            pattern=".tif")
piepules_slani=terra::rast(paste0("./SpeciesModels/",grupa,"/",suga_versija,"/",
                                  piepules_slaniem))
svaroti=piepules_slani*parklajumiem$svarots
svarota_piepule=terra::app(svaroti,"sum")
writeRaster(svarota_piepule,
            filename=paste0("./SpeciesModels/",
                            grupa,"/",
                            suga_versija,"/",
                            "EffortBiasLayer_",suga,".tif"),
            overwrite=TRUE)

svarota_piepule=terra::rast(paste0("./SpeciesModels/",
                                   grupa,"/",
                                   suga_versija,"/",
                                   "EffortBiasLayer_",suga,".tif"))
unlink(paste0("./SpeciesModels/",grupa,"/",suga_versija,"/",
              piepules_slaniem))

```


















